<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Image Converter — Single File</title>
  <!-- Tailwind Play CDN -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Optional: small icon set (heroicons outline) via simple inline svg usage below -->
  <style>
    /* Small custom styles to improve drag-drop look */
    .drop-zone.dragover { background: linear-gradient(90deg, rgba(99,102,241,0.06), rgba(236,72,153,0.03)); border-color: rgba(99,102,241,0.6); }
    input[type="number"]::-webkit-outer-spin-button, input[type="number"]::-webkit-inner-spin-button { -webkit-appearance: none; margin: 0; }
  </style>
</head>
<body class="bg-gray-50 text-gray-800 antialiased">
  <div class="max-w-6xl mx-auto p-6">
    <header class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-3">
        <div class="bg-gradient-to-br from-indigo-500 to-pink-500 text-white rounded-lg w-12 h-12 flex items-center justify-center shadow-lg">
          <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" viewBox="0 0 24 24" fill="none" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M3 7v10a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V7M16 3v4M8 3v4m-5 4h18"/></svg>
        </div>
        <div>
          <h1 class="text-2xl font-semibold">Image Converter</h1>
          <p class="text-sm text-gray-500">Convert, resize, compress, and download images — all in one file.</p>
        </div>
      </div>
      <div class="text-sm text-gray-500">No uploads. Runs locally in your browser.</div>
    </header>

    <main class="grid grid-cols-1 lg:grid-cols-3 gap-6">
      <!-- Left: Upload & Preview -->
      <section class="lg:col-span-2 bg-white p-6 rounded-2xl shadow-sm">
        <div class="flex flex-col lg:flex-row gap-6">
          <div class="flex-1">
            <label class="block text-sm font-medium text-gray-700 mb-2">Select image</label>
            <div id="dropZone" tabindex="0" class="drop-zone border-2 border-dashed border-gray-200 rounded-xl p-6 flex flex-col items-center justify-center gap-4 text-center focus:outline-none">
              <svg xmlns="http://www.w3.org/2000/svg" class="w-12 h-12 text-gray-400" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M7 16V8a4 4 0 118 0v8m-4 4v-4"/></svg>
              <div>
                <p class="text-sm text-gray-600">Drag & drop your image here, or</p>
                <div class="mt-3 flex items-center justify-center gap-3">
                  <label class="inline-flex items-center gap-2 px-4 py-2 bg-indigo-600 text-white rounded-lg cursor-pointer hover:opacity-95">
                    <input id="fileInput" type="file" accept="image/*" class="hidden" />
                    <span class="text-sm">Choose file</span>
                  </label>
                  <button id="pasteBtn" class="text-sm text-indigo-600 underline">Paste from clipboard</button>
                </div>
              </div>
            </div>

            <div class="mt-6 grid grid-cols-1 md:grid-cols-2 gap-4">
              <div>
                <label class="block text-sm font-medium text-gray-700">Preview</label>
                <div id="previewWrap" class="mt-2 bg-gray-50 rounded-lg p-3 min-h-[220px] flex items-center justify-center overflow-hidden">
                  <img id="previewImg" alt="preview" class="max-h-64 object-contain hidden" />
                  <div id="emptyPreview" class="text-sm text-gray-400">No image selected</div>
                </div>
              </div>

              <div>
                <label class="block text-sm font-medium text-gray-700">Info</label>
                <div class="mt-2 bg-gray-50 rounded-lg p-3 text-sm text-gray-700">
                  <div><strong id="infoName">—</strong></div>
                  <div class="mt-2 text-xs text-gray-500">Type: <span id="infoType">—</span></div>
                  <div class="mt-1 text-xs text-gray-500">Orig dimensions: <span id="infoDim">—</span></div>
                  <div class="mt-1 text-xs text-gray-500">Orig size: <span id="infoSize">—</span></div>
                </div>

                <div class="mt-4 text-sm text-gray-500">Tip: browsers differ in AVIF/WEBP encoding support. If a format isn't supported, try a different one.</div>
              </div>
            </div>
          </div>

          <!-- Right: Controls -->
          <aside class="w-full lg:w-80 bg-gray-50 p-4 rounded-xl">
            <h3 class="text-sm font-semibold mb-3">Output settings</h3>

            <label class="block text-xs font-medium text-gray-600">Format</label>
            <select id="format" class="mt-2 w-full rounded-md p-2 border border-gray-200 text-sm">
              <option value="image/png">PNG</option>
              <option value="image/jpeg">JPEG</option>
              <option value="image/webp">WEBP</option>
              <option value="image/avif">AVIF</option>
            </select>

            <div class="mt-4">
              <label class="block text-xs font-medium text-gray-600">Quality <span id="qualityVal" class="text-gray-500">90</span></label>
              <input id="quality" type="range" min="5" max="100" value="90" class="w-full mt-2" />
              <div class="text-xs text-gray-500 mt-1">Only used for lossy formats (JPEG / WEBP / AVIF).</div>
            </div>

            <div class="mt-4">
              <label class="block text-xs font-medium text-gray-600">Resize</label>
              <div class="flex gap-2 mt-2">
                <input id="width" type="number" placeholder="Width" class="w-1/2 rounded-md p-2 border border-gray-200 text-sm" />
                <input id="height" type="number" placeholder="Height" class="w-1/2 rounded-md p-2 border border-gray-200 text-sm" />
              </div>
              <div class="flex items-center gap-2 mt-2">
                <input id="keepAspect" type="checkbox" checked />
                <label for="keepAspect" class="text-xs text-gray-600">Keep aspect ratio</label>
              </div>
              <div class="text-xs text-gray-500 mt-1">Leave width/height blank to keep original dimensions.</div>
            </div>

            <div class="mt-4 grid grid-cols-2 gap-2">
              <div>
                <label class="block text-xs font-medium text-gray-600">Rotate</label>
                <input id="rotate" type="number" min="0" max="360" value="0" class="w-full rounded-md p-2 border border-gray-200 text-sm mt-2" />
              </div>
              <div>
                <label class="block text-xs font-medium text-gray-600">Flip</label>
                <div class="flex gap-2 mt-2">
                  <button id="flipH" class="flex-1 rounded-md p-2 border border-gray-200 text-sm">H</button>
                  <button id="flipV" class="flex-1 rounded-md p-2 border border-gray-200 text-sm">V</button>
                </div>
              </div>
            </div>

            <div class="mt-4">
              <label class="block text-xs font-medium text-gray-600">Output filename</label>
              <input id="outName" type="text" placeholder="converted" class="mt-2 w-full rounded-md p-2 border border-gray-200 text-sm" />
            </div>

            <div class="mt-6 flex gap-2">
              <button id="convertBtn" class="flex-1 bg-indigo-600 text-white rounded-lg py-2 font-medium">Convert</button>
              <button id="downloadBtn" class="flex-1 bg-white border border-gray-200 rounded-lg py-2 font-medium">Download</button>
            </div>

            <button id="resetBtn" class="mt-3 w-full text-xs text-red-600 underline">Reset</button>

            <div id="outputInfo" class="mt-4 text-xs text-gray-600">No output yet</div>
          </aside>
        </div>

        <!-- Advanced: result preview small -->
        <div class="mt-6">
          <label class="block text-sm font-medium text-gray-700 mb-2">Result preview</label>
          <div id="resultWrap" class="bg-white rounded-lg p-4 border border-gray-100 flex items-center gap-4 overflow-auto">
            <canvas id="resultCanvas" class="rounded-md shadow-sm max-h-60"></canvas>
            <div class="flex-1">
              <div class="text-sm font-medium" id="resultName">—</div>
              <div class="text-xs text-gray-500 mt-1" id="resultMeta">—</div>
            </div>
          </div>
        </div>
      </section>

      <!-- Right column: Help / Tips -->
      <aside class="bg-white p-6 rounded-2xl shadow-sm">
        <h3 class="text-lg font-semibold mb-2">How it works</h3>
        <ol class="text-sm text-gray-600 list-decimal list-inside space-y-2">
          <li>Choose or drag an image. It never leaves your browser.</li>
          <li>Pick output format and quality.</li>
          <li>Optionally resize, rotate or flip.</li>
          <li>Click Convert — then Download to save the converted file.</li>
        </ol>

        <div class="mt-4 text-sm text-gray-500">
          Supported formats depend on your browser. Modern Chromium and Safari support WebP and AVIF; if a format fails, try JPEG or PNG.
        </div>

        <div class="mt-6">
          <label class="block text-sm font-medium text-gray-700">Shortcuts</label>
          <ul class="text-sm text-gray-600 list-disc list-inside mt-2">
            <li><kbd class="bg-gray-100 px-2 py-1 rounded">Ctrl/Cmd + V</kbd> to paste image from clipboard.</li>
            <li><kbd class="bg-gray-100 px-2 py-1 rounded">Drag & Drop</kbd> to quickly add files.</li>
          </ul>
        </div>
      </aside>
    </main>

    <footer class="mt-8 text-center text-xs text-gray-400">Built with ❤️ • Runs 100% in browser • Single-file</footer>

  </div>

<script>
// Strict mode
'use strict';

// Elements
const fileInput = document.getElementById('fileInput');
const dropZone = document.getElementById('dropZone');
const previewImg = document.getElementById('previewImg');
const emptyPreview = document.getElementById('emptyPreview');
const infoName = document.getElementById('infoName');
const infoType = document.getElementById('infoType');
const infoDim = document.getElementById('infoDim');
const infoSize = document.getElementById('infoSize');
const formatEl = document.getElementById('format');
const qualityEl = document.getElementById('quality');
const qualityVal = document.getElementById('qualityVal');
const widthEl = document.getElementById('width');
const heightEl = document.getElementById('height');
const keepAspect = document.getElementById('keepAspect');
const rotateEl = document.getElementById('rotate');
const flipHBtn = document.getElementById('flipH');
const flipVBtn = document.getElementById('flipV');
const outName = document.getElementById('outName');
const convertBtn = document.getElementById('convertBtn');
const downloadBtn = document.getElementById('downloadBtn');
const resetBtn = document.getElementById('resetBtn');
const resultCanvas = document.getElementById('resultCanvas');
const resultName = document.getElementById('resultName');
const resultMeta = document.getElementById('resultMeta');
const outputInfo = document.getElementById('outputInfo');
const pasteBtn = document.getElementById('pasteBtn');

let currentFile = null;
let originalImage = null; // Image() instance
let lastBlob = null;
let flipH = false, flipV = false;

// Helpers
const humanFileSize = (bytes) => {
  if (!bytes) return '—';
  const i = Math.floor(Math.log(bytes) / Math.log(1024));
  return (bytes / Math.pow(1024, i)).toFixed(2) * 1 + ' ' + ['B','KB','MB','GB'][i];
}

function resetAll() {
  currentFile = null; originalImage = null; lastBlob = null; flipH=false; flipV=false;
  previewImg.src = '';
  previewImg.classList.add('hidden');
  emptyPreview.classList.remove('hidden');
  infoName.textContent = '—'; infoType.textContent = '—'; infoDim.textContent = '—'; infoSize.textContent = '—';
  resultName.textContent = '—'; resultMeta.textContent = '—';
  outputInfo.textContent = 'No output yet';
  resultCanvas.width = resultCanvas.height = 0;
}

resetBtn.addEventListener('click', () => {
  resetAll();
});

// File handling
fileInput.addEventListener('change', (e) => {
  const f = e.target.files[0];
  if (f) handleFile(f);
});

// Drag & drop
['dragenter','dragover'].forEach(ev => {
  dropZone.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.add('dragover'); });
});
['dragleave','drop'].forEach(ev => {
  dropZone.addEventListener(ev, (e) => { e.preventDefault(); e.stopPropagation(); dropZone.classList.remove('dragover'); });
});

dropZone.addEventListener('drop', (e) => {
  const f = e.dataTransfer.files && e.dataTransfer.files[0];
  if (f) handleFile(f);
});

// Paste support
pasteBtn.addEventListener('click', async ()=>{
  try {
    const items = await navigator.clipboard.read();
    for (const item of items) {
      for (const type of item.types) {
        if (type.startsWith('image/')) {
          const blob = await item.getType(type);
          handleFile(new File([blob], 'pasted-image.' + type.split('/')[1], { type }));
          return;
        }
      }
    }
    alert('No image found in clipboard. Try copying an image and paste again.');
  } catch (err) {
    console.warn('Clipboard API paste failed', err);
    alert('Paste from clipboard is not supported in this browser. Try Ctrl/Cmd+V or use the file picker.');
  }
});

// Also allow Ctrl/Cmd+V paste
window.addEventListener('paste', (e)=>{
  if (!e.clipboardData) return;
  const items = e.clipboardData.items;
  for (const it of items) {
    if (it.type.startsWith('image/')) {
      const blob = it.getAsFile();
      handleFile(blob);
      return;
    }
  }
});

async function handleFile(file) {
  if (!file.type.startsWith('image/')) { alert('Please select an image file.'); return; }
  currentFile = file;
  infoName.textContent = file.name;
  infoType.textContent = file.type;
  infoSize.textContent = humanFileSize(file.size);

  const url = URL.createObjectURL(file);
  const img = new Image();
  img.onload = () => {
    originalImage = img;
    infoDim.textContent = img.width + ' x ' + img.height;
    previewImg.src = url;
    previewImg.classList.remove('hidden');
    emptyPreview.classList.add('hidden');
    // prefill width/height
    widthEl.value = img.width;
    heightEl.value = img.height;
    outName.value = (file.name.replace(/\.[^/.]+$/, '') || 'converted');
  };
  img.onerror = ()=> { alert('Failed to load image.'); };
  img.src = url;
}

// UI interactions
qualityEl.addEventListener('input', ()=> qualityVal.textContent = qualityEl.value);

flipHBtn.addEventListener('click', ()=>{ flipH = !flipH; flipHBtn.classList.toggle('bg-indigo-50'); });
flipVBtn.addEventListener('click', ()=>{ flipV = !flipV; flipVBtn.classList.toggle('bg-indigo-50'); });

// Keep aspect
widthEl.addEventListener('input', ()=>{
  if (!originalImage) return;
  if (keepAspect.checked && widthEl.value) {
    const w = Number(widthEl.value);
    const h = Math.round(w * originalImage.height / originalImage.width);
    heightEl.value = h;
  }
});
heightEl.addEventListener('input', ()=>{
  if (!originalImage) return;
  if (keepAspect.checked && heightEl.value) {
    const h = Number(heightEl.value);
    const w = Math.round(h * originalImage.width / originalImage.height);
    widthEl.value = w;
  }
});

// Convert
convertBtn.addEventListener('click', async ()=>{
  if (!originalImage) { alert('Select an image first.'); return; }
  convertBtn.disabled = true; convertBtn.textContent = 'Converting...';
  try {
    const mime = formatEl.value;
    const q = Number(qualityEl.value) / 100;
    let targetW = originalImage.width;
    let targetH = originalImage.height;
    if (widthEl.value) targetW = Number(widthEl.value);
    if (heightEl.value) targetH = Number(heightEl.value);

    // draw on canvas with transforms
    const rad = (Number(rotateEl.value) % 360) * Math.PI / 180;
    // compute rotated canvas size
    const sin = Math.abs(Math.sin(rad)), cos = Math.abs(Math.cos(rad));
    const canvasW = Math.max(1, Math.round(targetW * cos + targetH * sin));
    const canvasH = Math.max(1, Math.round(targetW * sin + targetH * cos));

    const c = resultCanvas; const ctx = c.getContext('2d');
    c.width = canvasW; c.height = canvasH;
    ctx.save();
    // center
    ctx.translate(canvasW/2, canvasH/2);
    ctx.rotate(rad);
    // flips
    ctx.scale(flipH ? -1 : 1, flipV ? -1 : 1);
    // draw at centered offset
    ctx.drawImage(originalImage, -targetW/2, -targetH/2, targetW, targetH);
    ctx.restore();

    // convert canvas to blob
    const blob = await new Promise((resolve)=>{
      // Some browsers don't support avif in toBlob -> handle with try/catch
      try {
        c.toBlob((b)=> resolve(b), mime, (mime === 'image/png' ? undefined : q));
      } catch(e) {
        // fallback to webp or png
        console.warn('toBlob failed for', mime, e);
        c.toBlob((b)=> resolve(b), 'image/png');
      }
    });

    if (!blob) {
      alert('Conversion failed (format may not be supported by your browser).');
      outputInfo.textContent = 'Conversion failed.';
    } else {
      lastBlob = blob;
      resultName.textContent = (outName.value || 'converted') + '.' + mime.split('/')[1];
      resultMeta.textContent = 'Type: ' + blob.type + ' • Size: ' + humanFileSize(blob.size) + ' • Dimensions: ' + c.width + ' x ' + c.height;
      outputInfo.textContent = 'Conversion ready — click Download to save.';
    }
  } catch(err) {
    console.error(err); alert('Error during conversion: ' + (err.message || err));
  } finally {
    convertBtn.disabled = false; convertBtn.textContent = 'Convert';
  }
});

// Download
downloadBtn.addEventListener('click', ()=>{
  if (!lastBlob) { alert('No converted image available. Click Convert first.'); return; }
  const a = document.createElement('a');
  const url = URL.createObjectURL(lastBlob);
  a.href = url;
  const ext = lastBlob.type.split('/')[1] || 'png';
  a.download = (outName.value || 'converted') + '.' + ext;
  document.body.appendChild(a);
  a.click();
  a.remove();
  setTimeout(()=> URL.revokeObjectURL(url), 5000);
});

// Initialize
resetAll();

</script>
</body>
</html>
